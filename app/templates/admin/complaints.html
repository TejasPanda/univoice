{% extends "base.html" %}

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2 style="margin: 0;">Complaint Database Manager</h2>
    <a href="{{ url_for('main.admin_dashboard') }}" style="text-decoration: none; font-weight: bold;">
        ‚Üê Back to Dashboard
    </a>
</div>

<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #ddd;">
    <form method="GET">
        <label style="font-weight: bold;">Select Hostel:</label>
        <select name="hostel_id" onchange="this.form.submit()" style="padding: 6px 10px; margin-left: 10px; border-radius: 4px;">
            <option value="">-- Choose Hostel --</option>
            {% for h in hostels %}
                <option value="{{ h.id }}" {% if selected_hostel and selected_hostel.id == h.id %}selected{% endif %}>
                    {{ h.name }}
                </option>
            {% endfor %}
        </select>
    </form>
</div>

{% if selected_hostel %}

<div style="display: flex; gap: 15px; border-bottom: 2px solid #ddd; margin-bottom: 25px; flex-wrap: wrap;">
    {% set base_link = url_for('main.admin_view_complaints', hostel_id=selected_hostel.id) %}

    {% for status, color in {
        'pending': 'orange',
        'in_progress': 'blue',
        'resolved': 'green',
        'rejected': 'red',
        'flagged': 'grey'
    }.items() %}

    <a href="{{ base_link }}&status={{ status }}"
       style="padding: 10px 15px;
              text-decoration: none;
              color: black;
              border-bottom: 3px solid {% if current_status == status %}{{ color }}{% else %}transparent{% endif %};
              font-weight: bold;">
        {{ status.replace('_',' ').title() }} ({{ counts[status] }})
    </a>

    {% endfor %}
</div>

{% if not complaints %}
    <p style="padding: 20px; color: #666;">No complaints found in this category.</p>
{% else %}

<table style="width: 100%; border-collapse: collapse; font-size: 0.95em; border: 1px solid #ddd;">
    <thead style="background: #343a40; color: white;">
        <tr>
            <th style="padding: 10px;">Date</th>
            <th style="padding: 10px;">Student</th>
            <th style="padding: 10px;">Category</th>
            <th style="padding: 10px;">Issue</th>
            <th style="padding: 10px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for c in complaints %}
        <tr style="background: #ffffff; text-align: center; border-bottom: 1px solid #ddd;">
            <td style="padding: 8px;">{{ c.created_at.strftime('%Y-%m-%d') }}</td>
            <td style="padding: 8px;">
                {{ c.author.name }} <br>
                <small style="color: #555;">Room {{ c.author.room_number }}</small>
            </td>
            <td style="padding: 8px;">{{ c.category.value|upper }}</td>

            <td style="text-align: left; padding: 10px;">
                <details>
                    <summary style="cursor: pointer; font-weight: bold; color: #007bff;">
                        {{ c.heading }}
                    </summary>
                    <div style="margin-top: 10px; padding: 10px; background: #fffbe6; border: 1px solid #ebdcb2; border-radius: 4px;">
                        <p style="margin:0;">{{ c.description }}</p>

                        {% if c.warden_comment %}
                            <hr>
                            <p style="margin:0; color: darkblue;">
                                <strong>Warden:</strong> {{ c.warden_comment }}
                            </p>
                        {% endif %}

                        {% if c.mentor_comment %}
                            <p style="margin:0; color: purple;">
                                <strong>Mentor:</strong> {{ c.mentor_comment }}
                            </p>
                        {% endif %}
                    </div>
                </details>
            </td>

            <td style="padding: 8px;">
                <form action="{{ url_for('main.admin_delete_complaint', complaint_id=c.id) }}"
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to permanently delete this complaint?');">
                    <button type="submit"
                            style="background: #dc3545;
                                   color: white;
                                   border: none;
                                   padding: 6px 12px;
                                   border-radius: 4px;
                                   cursor: pointer;
                                   font-weight: bold;">
                        Delete
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endif %}

{% else %}
    <p>Please select a hostel above to view records.</p>
{% endif %}

{% endblock %}
